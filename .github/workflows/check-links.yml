# NOTE: Must use this in same workflow as artefact upload
name: CHECK-LINKS

on:
  workflow_call:
    inputs:
      artefact-ref:
        required: true
        type: string

jobs:

  check-links:
    name: Checking Links ðŸ”—
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:

      - name: Checkout SS-Pipelines
        uses: actions/checkout@v3
        with:
          repository: 'dr3dr3/ss-pipeline'
          ref: 'main'
          token: ${{ secrets.GHA_PAT }}

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ inputs.artefact-ref }}
          path: _site

      - name: Setup Node.JS
        uses: actions/setup-node@v3
        with:
          node-version: 16

      # https://github.com/JustinBeckwith/linkinator
      - name: Install Linkinator
        run: |
          npm install linkinator

      - name: Check links to JS files
        id: results-js
        run: |
          echo "### Linkinator .JS" >> $GITHUB_STEP_SUMMARY
          echo $(npx linkinator "_site/**/*.js" --config "./config/linkinator.config.json") >> $GITHUB_STEP_SUMMARY
          echo $(npx linkinator "_site/**/*.js" --config "./config/linkinator.config.json") >> links-js.json
          echo 'JS='$(jq '.passed' links-js.json) >> $GITHUB_OUTPUT

      - name: Fail workflow - JS
        if: ${{ steps.results-js.outputs.JS != 'true' }}
        run: exit 1

      - name: Check links to HTML files
        id: results-html
        run: |
          echo "### Linkinator .HTML" >> $GITHUB_STEP_SUMMARY
          echo $(npx linkinator "_site/**/*.html" --config "./config/linkinator.config.json") >> $GITHUB_STEP_SUMMARY
          echo $(npx linkinator "_site/**/*.html" --config "./config/linkinator.config.json") >> links-html.json
          echo 'HTML='$(jq '.passed' links-html.json) >> $GITHUB_OUTPUT

      - name: Fail workflow - HTML
        if: ${{ steps.results-html.outputs.HTML != 'true' }}
        run: exit 1

      - name: Check links to CSS files
        id: results-css
        run: |
          echo "### Linkinator .CSS" >> $GITHUB_STEP_SUMMARY
          echo $(npx linkinator "_site/**/*.css" --config "./config/linkinator.config.json") >> $GITHUB_STEP_SUMMARY
          echo $(npx linkinator "_site/**/*.css" --config "./config/linkinator.config.json") >> links-css.json
          echo 'CSS='$(jq '.passed' links-css.json) >> $GITHUB_OUTPUT

      - name: Fail workflow - CSS
        if: ${{ steps.results-css.outputs.CSS != 'true' }}
        run: exit 1

#      - name: Check links to MD files
#        id: results-md
#        run: |
#          echo $(npx linkinator "_site/**/*.md") >> $GITHUB_STEP_SUMMARY
#          echo $(npx linkinator "_site/**/*.md" --format JSON --markdown) >> links-md.json
#          echo 'MD='$(jq '.passed' links-md.json) >> $GITHUB_OUTPUT

#      - name: Fail workflow - MD
#        if: ${{ steps.results-md.outputs.MD != 'true' }}
#        run: exit 1

#      - name: Check external links
#        id: results-ext
#        run: |
#          echo $(npx linkinator "https://dr3dr3.github.io/devops-demo-stg" --recurse) >> $GITHUB_STEP_SUMMARY
#          echo $(npx linkinator "npx linkinator "https://dr3dr3.github.io/devops-demo-stg" --recurse --format JSON) >> links-ext.json
#          echo 'EXT='$(jq '.passed' links-ext.json) >> $GITHUB_OUTPUT

#      - name: Fail workflow - External
#        if: ${{ steps.results-ext.outputs.EXT != 'true' }}
#        run: exit 1