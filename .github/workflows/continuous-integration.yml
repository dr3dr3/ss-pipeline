# Continuous integration for all static site solutions
name: continuous-integration

on:

  # Called from solution repo on pull request event
  workflow_call:
    inputs:
      ss-solution:
        required: true
        type: string
        # string must be one of:
        # 'reveal-md'
        # 'dora-metrix'
      slfb: # Short-lived Feature Branch name
        required: true
        type: string

jobs:

  # Build static site using Reveal-MD
  build-revealmd:
    name: Build R-MD
    if: ${{ inputs.ss-solution == 'reveal-md' }}
    uses: ./.github/workflows/build-revealmd.yml
    secrets: inherit
    with: 
      target-ref: ${{ github.sha }}
      deploy-target: 'ci'

  # Check builds ok. Is a required check on the PR (setup in GitHub). 
  merge-ready:
    name: Ready for Merge
    needs: [build-revealmd] ### ADD MORE SS SOLUTIONS
    if: |
      always() &&
      !contains(needs.*.result, 'failure') &&
      !contains(needs.*.result, 'cancelled')
    runs-on: ubuntu-latest 
    steps:
      - name: Ready message
        run: echo "### Merge Ready :thumbsup:" >> $GITHUB_STEP_SUMMARY     

  # Merge PR. GitHub setup to delete SLFB after merge completed.
  pr-merge: 
    name: PR Merge
    needs: [merge-ready]
    if: ${{ github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:

      - name: Checkout Feature Branch
        uses: actions/checkout@v3

      - name: Merge Pull Request
        run: gh pr merge ${{ inputs.slfb }} --squash --subject "${{ inputs.slfb }}" --body "Short-lived feature branch ${{ inputs.slfb }} automerged by GitHub Action" --auto
        env:
          GH_TOKEN: ${{ secrets.PR_MERGE }}

      - name: GitHub Step Summary
        run: echo "### PR Merge Success! :thumbsup:" >> $GITHUB_STEP_SUMMARY

  # Deploy CI to GitHub Pages
  deploy-ci:
    name: Deploy CI
    needs: [pr-merge]
    if: ${{ github.event_name != 'workflow_dispatch' }}
    uses: ./.github/workflows/deploy-github-pages.yml
    with:
      target-ref: 'main'
      artefact-ref: ${{ github.sha }}
      deploy-target: 'ci'

  # Dispatch to Deploy to Stage Environment
  dispatch-stg:
    name: Dispatch STG
    needs: [pr-merge]
    uses: ./.github/workflows/continuous-deployment.yml
    with:
      target-ref: 'main'
      deploy-target: 'stg'
# End of workflow