name: CONTINUOUS-DELIVERY

on:

  workflow_call:
    inputs:
      target-deploy:
        required: true
        type: string

jobs:

  get-build-artefacts:
    name: Get Build Artefacts
    outputs:
      build-rmd: ${{ steps.build-rmd.outputs.RMD }}   
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:

      - name: Checkout GitOps
        uses: actions/checkout@v3
        with:
          repository: 'dr3dr3/ss-gitops'
          ref: 'main'
          token: ${{ secrets.GHA_PAT }}

      ### Reveal-MD Solution

      - name: Config RMD
        id: build-rmd
        run: |
          value="$(yq '.deploy.revealmd.build.target' 'config.yml')" || 'ERROR'
          echo "RMD=$value" >> $GITHUB_OUTPUT

      - name: Reveal-MD Build Artefact
        run: |
          wget "https://github.com/dr3dr3/devops-demo/releases/download/${{ steps.build-rmd.outputs.RMD }}/build.tar.gz"
          tar -xzvf build.tar.gz

      - name: Rename index.html from Reveal-MD
        run: rsync -avh _site/index.html _site/links.html


      # Add placeholder index.html (overwrites index.html created by Reveal-MD)
      - name: index.html with canary redirect
        if: ${{ inputs.target-deploy == 'prd' }}
        run: echo "<!doctype html><html lang='en'><head><title>Test</title><script>var url_25 = 'http://can.andredreyer.com'; var choice = Math.floor((Math.random() * 4)); if(choice == 3){window.location = url_25;}</script></head><body><p>Reveal-MD ${{ steps.build-rmd.outputs.RMD }}</p><p>Environment = ${{ inputs.target-deploy }}</p></body></html>" > _site/index.html

      - name: index.html
        if: ${{ inputs.target-deploy != 'prd' }}
        run: echo "<!doctype html><html lang="en"><head><title>Test</title></head><body><p>Reveal-MD ${{ steps.build-rmd.outputs.RMD }}</p><p>Environment = ${{ inputs.target-deploy }}</p></body></html>" > _site/index.html

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ format('{0}-{1}', 'RC', github.run_id ) }}
          path: _site
          retention-days: 1
  
  # Check links working in compiled deploy artefact
  check-links:
    name: Check Links
    needs: [get-build-artefacts]
    uses: ./.github/workflows/check-links.yml
    secrets: inherit
    with: 
      artefact-ref: ${{ format('{0}-{1}', 'RC', github.run_id ) }}

  # Deploy to GitHub Page
  deploy-to-github-pages:
    name: Deploy GHP
    needs: [get-build-artefacts, check-links]
    uses: ./.github/workflows/deploy-github-pages.yml
    permissions:
      contents: read
      pages: write
      id-token: write
    with:
      artefact-ref: ${{ format('{0}-{1}', 'RC', github.run_id ) }}
    secrets: inherit

  # Do different testing (smoke, PVT, etc)

  # Check all acceptance tests completed
  acceptance-complete:
    name: AcceptanceðŸ‘
    needs: [check-links, deploy-to-github-pages] ### ADD ALL CHECKS
    if: |
      always() &&
      !contains(needs.*.result, 'failure') &&
      !contains(needs.*.result, 'cancelled')
    runs-on: ubuntu-latest 
    steps:

      - name: Ready message
        run: echo "### Acceptance Completed :thumbsup:" >> $GITHUB_STEP_SUMMARY

      - name: Send IFTTT message that deploy successful
        run: |
          curl -X POST -H 'Content-Type: application/json' https://maker.ifttt.com/trigger/gha_${{ inputs.target-deploy }}_green/json/with/key/${{ secrets.IFTTT }}

  # Given successful testing then update the build for this environment in GitOps Config
  build-rmd:
    name: Actual Build for RMD
    needs: [get-build-artefacts, acceptance-complete]
    uses: ./.github/workflows/gitops-update.yml
    with:
      config-item: '.deploy.revealmd.build.${{ inputs.target-deploy }}'
      config-value: ${{ needs.get-build-artefacts.outputs.build-rmd }}
    secrets: inherit

  # Do for other solutions as well